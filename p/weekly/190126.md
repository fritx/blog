# äº®çˆ·Weekly 0126

> è¡¥å‘..

---

[0125] vue-threejs vue-cli-3 å‡çº§ç¬”è®°<br>
\- ï¼ˆdevDepsè¡¥å……vueï¼‰<br>
\-  å¿…é¡» import * as VueThreejs // testing build/pack https://github.com/fritx/vue-threejs/issues/14<br>
\- externals ä¿®æ­£ https://github.com/vuejs/vue-cli/issues/2646<br>
\- jest test-utilsæµ‹è¯• https://vue-test-utils.vuejs.org/guides/testing-single-file-components-with-jest.html<br>
\- inject/default https://github.com/vuejs/vue/issues/6097<br>
\- ...

```js
config.merge({
  // https://github.com/vuejs/vue-cli/issues/2646
  externals: {
    vue: {
      commonjs: 'vue',
      commonjs2: 'vue',
      root: 'Vue',
    },
    three: {
      commonjs: 'three',
      commonjs2: 'three',
      root: 'THREE',
    },
    'dat.gui': {
      commonjs: 'dat.gui',
      commonjs2: 'dat.gui',
      // https://github.com/dataarts/dat.gui/blob/1b18f7227e56c8b5071337732342101501b9fa95/rollup.config.js#L30
      root: 'dat',
    },
    oimo: {
      commonjs: 'oimo',
      commonjs2: 'oimo',
      // https://github.com/lo-th/Oimo.js/blob/0ce1c3d8ff3f857d9180035076a70d8d6976a3e6/rollup.config.js#L7
      root: 'OIMO',
    },
  }
})
```

---

[0124] csrf-demo æ·±åº¦æ¨¡æ‹Ÿå®éªŒæŠ¥å‘Š

\- [x] ç³»ç»ŸåŸºæœ¬å®ç°<br>
\- [x] ä¸åŒç‰ˆæœ¬çš„æ”»å‡»+é˜²å®ˆå®ç°<br>
\- [x] è‡ªåŠ¨æµ‹è¯•æ‰€æœ‰åŒ¹é…å…³ç³»å¹¶ç»Ÿè®¡ç»“æœ<br>
\- [ ] è¡¥å……åŒ…å«ç™»å½•çŠ¶æ€

- æ”»å‡»æ–¹å› å­
  - `<form>` è‡ªåŠ¨æäº¤
    - Content-Type
      - `application/x-www-form-urlencoded` (g1)
      - `text/plain` (g2)
        - JSON å·§å¦™æ‹¼å‡‘ (g3)

- é˜²å®ˆæ–¹å› å­
  - koa-body è§£æ
    - éªŒè¯ç 
    - API-Token
    - CSRF-Token
    - X-Requested-With
    - Origin æ ¡éªŒ
    - Referer æ ¡éªŒ
    - form æ ¼å¼æ¥æ”¶ (f1)
    - JSON æ ¼å¼æ¥æ”¶ (f2)
      - è‡ªä¸» JSON.parse (f3)
      - Content-Type æ ¡éªŒ (f4)

| é˜²å®ˆ/æ”»å‡» | g1 | g2 | g2+g3 |
| :---: | :---: | :---: | :---: |
| f1 | ğŸ’€ | ï¼Ÿ | - |
| f2 | ğŸ’€ | ï¼Ÿ | âœ… |
| f2+f3 | ğŸ’€ | ï¼Ÿ | ğŸ’€ |
| f2+f4 | âœ… | âœ… | âœ… |

\- åŸºäº TypeScriptï¼ŒEditor è¦æ±‚ä¸º VS-Code<br>
\- åŸºäº Koaï¼Œå‰ç«¯ä¸ºåŸå§‹ Vue ä»£ç ï¼Œç®€å•åŒ–

```sh
# è¿è¡Œç³»ç»Ÿ
npm run dev

# æ¨¡æ‹Ÿ æ™®é€šç”¨æˆ· é“¶è¡Œè½¬è´¦é¡µé¢
# http://localhost:7007/bank/transfer

# æ¨¡æ‹Ÿ æ”»å‡»è€…å‘èµ·CSRFæ”»å‡» é’“é±¼é¡µé¢
# http://localhost:7009/attacker/phishing
```

å‚è€ƒèµ„æ–™<br>
\- How can the Origin header be used for CSRF prevention if Firefox doesn't send it for same origin requests or requests from data URIs? https://security.stackexchange.com/questions/137310/how-can-the-origin-header-be-used-for-csrf-prevention-if-firefox-doesnt-send-it<br>
\- Jquery, No X-Requested-With=XMLHttpRequest in ajax request header? https://stackoverflow.com/questions/1885847/jquery-no-x-requested-with-xmlhttprequest-in-ajax-request-header<br>
\- å…³äºajaxè¯·æ±‚çš„å®‰å…¨ï¼Œå¦‚ä½•é¿å…csrfç±»ä¼¼çš„æ”»å‡»ï¼Ÿ https://www.zhihu.com/question/39011147

---

[0122] csrf ä¸ json

åº”å¯¹æ–¹æ¡ˆ<br>
1\. èº«ä»½è¯†åˆ«ä»¥ Token å–ä»£ Cookie<br>
2\. è¡¨å•å¼•å…¥ CSRF-Token<br>
3\. å¼ºåˆ¶ JSON æ ¼å¼åŠ Content-Type<br>
4\. Refererã€is-xhr...

```js
const koaJson = koaMerge(koaBody, async (ctx, next) => {
  let contentType = ctx.headers['content-type']
  if (contentType !== 'application/json') {
    ctx.throw(400, new Error(`invalid content-type, got: ${contentType}`))
  }
  let { body } = ctx.request
  mongoSanitizeRecursive(body)
  ctx.request.body = body
  await next()
})
```

å‚è€ƒé“¾æ¥<br>
\- å…³äºajaxè¯·æ±‚çš„å®‰å…¨ï¼Œå¦‚ä½•é¿å…csrfç±»ä¼¼çš„æ”»å‡»ï¼Ÿ - éƒ­å°æˆçš„å›ç­” - çŸ¥ä¹
https://www.zhihu.com/question/39011147/answer/152441324

---

[0120] vscode terminal è®¾ç½®nodeç‰ˆæœ¬ ä¸nvmä¸€è‡´<br>
https://stackoverflow.com/questions/44700432/visual-studio-code-to-use-node-version-specified-by-nvm/53596328#53596328

> Apparently the default shellArgs for osx are set to bash while I'm using zsh. I solved the problem by setting the shellArgs in my user settings to an empty array:

```js
"terminal.integrated.shellArgs.osx": []
```

---

[0116] vue-cli-3 uglifyjs drop_console å‚æ•°è¿ç§»<br>
https://forum.vuejs.org/t/remove-console-logs-from-production-buils/39327

```sh
npm i -D babel-plugin-transform-remove-console
```

```js
let plugins = []

// https://forum.vuejs.org/t/remove-console-logs-from-production-buils/39327
if (process.env.NODE_ENV === 'production') {
  plugins.push('transform-remove-console')
}

module.exports = {
  presets: [
    '@vue/app'
  ],
  plugins
}

```

---

[0116] vue-cli-3 webpack-chain è¡¥å……define-plugin envå‚æ•°è¿ç§»

```js
let merge = require('webpack-merge') // æˆ–è€…å…¶ä»– deepMerge
// ...
  config
    .plugin('define')
    .tap(args => {
      // Bad
      // return [...args, {
      //   'process.env': process.env.NODE_ENV === 'production'
      //     ? require('./config/prod.env')
      //     : require('./config/dev.env')
      // }]
      // ç» jingmin æŒ‡ç‚¹ï¼Œæ­¤å¤„éœ€ä¿®æ”¹ `args[0]`
      // Good
      args[0] = merge(args[0], {
        'process.env': process.env.NODE_ENV === 'production'
          ? require('./config/prod.env')
          : require('./config/dev.env')
      })
      return args
    })
``` 

---

[0114] mpwxæŠ“å– å°å›¾æ ‡ç§»é™¤ å¢å¼ºè¯†åˆ« (åˆ¤æ–­styleä¸­widthå€¼)

```js
// ç§»é™¤å°å›¾æ ‡ ç›®å‰å°ç¨‹åºæ²¡æœ‰åˆé€‚çš„å±•ç¤ºæ–¹å¼ åªæœ‰å¤§å›¾
$('[style*="width:"]').each((i, el) => {  // æ–°å¢
  let $el = $(el)
  let mat = $el.attr('style').match(/width:\s*([^\s;]+)/)
  let isSmallIcon = false
  if (mat) {
    let width = mat[1]
    if (/%$/.test(width)) {
      let v = +width.replace(/%$/, '')
      if (v < 15) isSmallIcon = true
    } else if (/px$/.test(width)) {
      let v = +width.replace(/px$/, '')
      if (v < 90) isSmallIcon = true
    }
  }
  if (isSmallIcon) {
    $el.remove()
  }
})
$('img[data-w]').each((i, el) => { // åŸæœ‰
  let $el = $(el)
  if (+$el.attr('data-w') < 50) {
    $el.remove()
  }
})
```
